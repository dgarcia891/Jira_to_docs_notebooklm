import{f as $}from"./docUtils-BQsI6kcp.js";function w(e){if(!e)return"";let t="";switch(e.type){case"doc":case"paragraph":case"bulletList":case"orderedList":case"listItem":case"blockquote":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=w(r)}),e.type!=="doc"&&(t+=`
`));break;case"text":t+=e.text||"";break;case"hardBreak":t+=`
`;break;case"inlineCard":case"blockCard":case"embedCard":e.attrs&&e.attrs.url?t+=` [Link: ${e.attrs.url}] `:t+=" [Linked Item] ";break;case"mention":e.attrs&&e.attrs.text?t+=` ${e.attrs.text} `:t+=" @user ";break;case"extension":case"bodiedExtension":case"inlineExtension":t+=` [Embedded Content: ${e.attrs?.extensionKey||"Extension"}] `;break;case"table":case"tableRow":case"tableHeader":case"tableCell":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=w(r),(e.type==="tableCell"||e.type==="tableHeader")&&(t+=" | ")}),e.type==="tableRow"&&(t+=`
`));break;default:e.content&&Array.isArray(e.content)&&e.content.forEach(r=>{t+=w(r)});break}return t}function v(e,t){if(!e)return"";const r=["Sort in ascending order","Sort in descending order","Sort A to Z","Sort Z to A","More actions for","â€¢",t,"Assign to me","Assign to","None","Add a descriptionâ€¦","Add a description"];let n=e;r.forEach(a=>{n=n.replace(new RegExp(a,"gi"),"")}),n=n.replace(/Sort A to Z.*/gi,""),n=n.replace(/More actions for.*/gi,"");const s=n.trim().split(/\s+/),c=[];for(let a=0;a<s.length;a++)(a===0||s[a].toLowerCase()!==s[a-1].toLowerCase())&&c.push(s[a]);return c.join(" ")||"Pending"}function x(e){let t=j(e);return/add\s+a\s+description/i.test(t)?"":t}function U(e){if(e.toLowerCase()==="unassigned")return"Unassigned ðŸ‘¤";let t=e.replace(/^Assignee/i,"").trim();return["Sort A to Z","More actions for Assignee","Sort A to ZMore actions for Assignee","â€¢"].forEach(n=>t=t.replace(n,"")),v(t,"Assignee").trim()}function j(e){return!e||e==="_No description provided_"?"_No description provided_":e.replace(/<br\s*\/?>/gi,`
`).replace(/<\/p>/gi,`

`).replace(/<[^>]*>/g,"").replace(/([.:])([A-Z])/g,`$1

$2`).replace(/\n{3,}/g,`

`).trim()}function I(e){const t=e.match(/browse\/([A-Z]+-\d+)/);return t?t[1]:""}function L(e){const t=e.toLowerCase();return t.includes("bug")?"bug":t.includes("story")?"story":t.includes("epic")?"epic":t.includes("task")?"task":"other"}function S(e,t){const n=new DOMParser().parseFromString(e,"text/html"),s=n.body;s.querySelectorAll('[data-node-type="inlineCard"], [data-node-type="blockCard"], .jira-issue-card, .smart-link, [data-testid*="inline-card"], [data-testid*="issue.views.issue-base.content.issue-links"]').forEach(l=>{const d=l.querySelector("a");let f="[Linked Issue]";if(d){const y=(d.getAttribute("href")||"").match(/browse\/([A-Z]+-\d+)/);y?f=` ${y[1]} `:f=` ${d.textContent?.trim()||"Linked Issue"} `}else if(l.getAttribute("data-card-data"))try{const p=JSON.parse(l.getAttribute("data-card-data")||"{}");p.url&&(f=` [${p.url}] `)}catch{}f.length>50&&(f=" [Linked Link] ");const h=n.createTextNode(f);l.parentNode?.replaceChild(h,l)}),s.querySelectorAll("style, script, svg").forEach(l=>l.remove());let i=s.innerText||s.textContent||"";return i=i.replace(/\n\s*\n\s*\n/g,`

`).replace(/[ \t]+/g," "),i.trim()}async function P(e,t,r){console.log(`JiraParser: Discovering children for Epic ${e}...`);const n=await fetch(`${t}/rest/api/3/search/jql`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-Atlassian-Token":"no-check","X-Requested-With":"XMLHttpRequest",...r},body:JSON.stringify({jql:`"parent" = ${e} OR "Epic Link" = ${e} order by created ASC`,fields:["key"],maxResults:100})});if(!n.ok){const c=await n.text().catch(()=>"Unknown error");throw new Error(`Failed to fetch epic children for ${e} (${n.status}): ${c}`)}return(await n.json()).issues.map(c=>c.key)}async function T(e,t,r,n){try{const s=["summary","description","status","priority","comment",t["t-shirt size"]].filter(Boolean).join(","),c=await fetch(`${r}/rest/api/3/issue/${e}?fields=${s}`,{headers:{Accept:"application/json",...n}});if(!c.ok)return{key:e,title:"Error fetching",url:`${r}/browse/${e}`};const i=(await c.json()).fields||{},l=t["t-shirt size"],d=l&&(i[l]?.value||i[l]?.name||i[l])||"",f=i.description?w(i.description):"No description provided.",h=i.status?.name||"Unknown",p=i.priority?.name||"Medium",y=i.comment?.comments||[],C=y.map(g=>{let o="";try{o=w(g.body)}catch{o=String(g.body)}return{id:g.id,author:g.author?.displayName||"Unknown User",body:o.trim(),timestamp:$(g.created)}}).reverse(),k=C.length>0?B(y[y.length-1].body):"No technical notes recorded.";return{id:e,key:e,title:i.summary||"",description:f,status:h,priority:p,comments:C,tShirtSize:d,rationale:k,url:`${r}/browse/${e}`}}catch{return{key:e,title:"Network Error",url:`${r}/browse/${e}`}}}function B(e){const r=w(e).split(`
`).filter(n=>n.trim().length>0);return r.slice(0,2).join(" ")+(r.length>2?"...":"")}async function R(e,t,r,n){if(!n)return[];try{console.log(`JiraParser: Fetching comments for ${n} via API...`);const s=await fetch(`${e}/rest/api/3/issue/${n}/comment?expand=renderedBody`,{method:"GET",headers:{Accept:"application/json",...t}});if(!s.ok)return console.error(`JiraParser: API Error ${s.status} ${s.statusText}`),s.status===401||s.status===403?[{id:"error-auth",author:"System",body:"Error: Could not access Jira API. Please ensure you are logged in.",timestamp:new Date().toISOString()}]:[];const c=await s.json();return!c.comments||!Array.isArray(c.comments)?[]:c.comments.map((i,l)=>{let d="";if(i.body&&typeof i.body=="object")try{d=w(i.body)}catch{i.renderedBody&&(d=S(i.renderedBody,r))}else i.renderedBody?d=S(i.renderedBody,r):i.body&&typeof i.body=="string"?d=i.body:d="[Content Not Available]";const f=i.author?.displayName||"Unknown User",h=$(i.created);return{id:i.id||`comment-${l}`,author:f,body:d.trim(),timestamp:h}}).filter(i=>i!==null).reverse()}catch(s){return console.error("JiraParser: API Fetch Exception",s),[{id:"error-exception",author:"System",body:`Error: API Fetch failed. ${s}`,timestamp:new Date().toISOString()}]}}class N{canParse(t){return/atlassian\.net\/(browse\/|jira\/software\/.*(selectedIssue=|issues\/))/.test(t)}baseUrlOverride=null;jiraEmail=null;jiraApiToken=null;setCredentials(t,r){this.jiraEmail=t,this.jiraApiToken=r}setBaseUrl(t){try{const r=new URL(t);this.baseUrlOverride=`${r.protocol}//${r.host}`}catch{this.baseUrlOverride=null}}getApiUrl(t){return this.baseUrlOverride?`${this.baseUrlOverride}${t}`:t}getBaseUrl(){return this.baseUrlOverride||""}getAuthHeaders(){return this.jiraEmail&&this.jiraApiToken?{Authorization:`Basic ${btoa(`${this.jiraEmail}:${this.jiraApiToken}`)}`}:{}}async parse(t,r){this.setBaseUrl(r);let n=I(r);if(n||(n=t.querySelector('[data-testid="issue.views.issue-base.foundation.breadcrumbs.breadcrumb-current-issue-container"] a')?.textContent?.trim()||""),!n)throw new Error("Could not extract Issue Key");return this.parseByKey(n,t)}async parseByKey(t,r){console.log(`JiraParser: Fetching issue ${t} data via API...`);let n={};try{const o=await fetch(this.getApiUrl("/rest/api/3/field"),{headers:{Accept:"application/json",...this.getAuthHeaders()}});o.ok&&(await o.json()).forEach(m=>{n[m.name.toLowerCase()]=m.id})}catch(o){console.warn("JiraParser: Field discovery failed",o)}const s=await fetch(this.getApiUrl(`/rest/api/3/issue/${t}`),{method:"GET",headers:{Accept:"application/json",...this.getAuthHeaders()}});if(!s.ok)throw new Error(`JiraParser: API Error ${s.status} fetching issue ${t}`);const a=(await s.json()).fields||{},i=o=>{const m=o.map(A=>A.toLowerCase()).map(A=>n[A]).filter(A=>A!==void 0);for(const A of m){let u=a[A];if(u!=null){if(Array.isArray(u)&&u.length>0&&(u=u[0]),typeof u=="object")return u.value?u.value:u.name?u.name:JSON.stringify(u);if(String(u).trim()!=="")return String(u)}}return"N/A"},l=a.issuetype?.name||"other",d=L(l),f=`${this.getBaseUrl()||window.location.origin}/browse/${t}`,h=await R(this.getBaseUrl(),this.getAuthHeaders(),r||null,t);let p=i(["t-shirt size","tshirt","sizing","size","et - size"]);if(p==="N/A"){const o=Object.keys(a).filter(b=>b.startsWith("customfield_"));for(const b of o){const m=a[b];if(m&&typeof m=="object"&&m.value&&/^(XS|S|M|L|XL|XXL)$/i.test(m.value)){p=m.value;break}}}if(p==="N/A"&&h.length>0){const o=/estimated as (XS|S|M|L|XL|XXL)/i;for(const b of h){const m=b.body.match(o);if(m){p=m[1].toUpperCase();break}}}let y=[];const C=a.issuelinks||[],k=a.subtasks||[],g=[...C.filter(o=>o.type?.name!=="Cloners").map(o=>(o.outwardIssue||o.inwardIssue)?.key),...k.map(o=>o.key)].filter(Boolean).slice(0,10);return g.length>0&&(y=await Promise.all(g.map(o=>T(o,n,this.getBaseUrl(),this.getAuthHeaders())))),{id:t,source:"jira",key:t,title:a.summary||"",description:x(a.description?w(a.description):""),status:a.status?.name||"Pending",type:d,priority:a.priority?.name||"Medium",assignee:U(a.assignee?.displayName||"Unassigned"),reporter:a.reporter?.displayName||"Unknown",labels:a.labels||[],url:f,comments:h,createdDate:a.created,updatedDate:a.updated,sprints:a[n.sprint]?.map(o=>o.name)||[],tShirtSize:p,storyPoints:i(["story points","story point estimate","point estimate","points"]),workType:i(["work type","work item type"]),businessTeam:i(["requesting business team","team"]),businessObjective:i(["business objective","goal","business value"]),impact:i(["et - impact","impact","level","severity","class"]),linkedIssues:y.filter(Boolean),metadata:a}}async fetchEpicChildren(t){return P(t,this.getBaseUrl(),this.getAuthHeaders())}}console.log("Jira to NotebookLM: Content script loaded");const E=new N;chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="EXTRACT_ISSUE")return _().then(r),!0;if(e.type==="GET_ISSUE_KEY")return O().then(r),!0;if(e.type==="FETCH_EPIC_BULK")return F(e.payload.epicKey).then(r),!0});async function O(){try{const e=window.location.href;if(!E.canParse(e))return{error:"Not a supported Jira Issue URL"};const t=e.match(/browse\/([A-Z]+-\d+)/),r=t?t[1]:void 0,n=document.querySelector("h1")?.innerText||document.title;let s="";const c=document.querySelector('[data-testid="issue.views.field.issue-type.common.ui.issue-type-field-view"] [data-testid*="issue-type-icon"]');if(c&&(s=c.textContent?.trim()||""),s||document.querySelector('img[alt*="Epic"]')&&(s="Epic"),s||document.querySelector('[aria-label*="Epic"]')&&(s="Epic"),!s){const i=document.querySelectorAll('[data-testid*="issue-type"]');for(const l of i)if((l.textContent?.trim()||"").toLowerCase().includes("epic")){s="Epic";break}}if(!s){const i=document.querySelector('[data-testid="issue-field-summary.ui.issue-field-summary-inline-edit--trigger"]');if(i){const l=i.querySelector('span[data-testid*="issue-type-icon"]');l?s=l.textContent?.trim()||"":s=i.textContent?.trim()||""}}let a=[];if(s.toLowerCase().includes("epic")&&r)try{console.log(`Content: Epic detected (${r}), fetching child keys for dynamic naming...`),a=await E.fetchEpicChildren(r)}catch(i){console.warn("Content: Failed to fetch child keys for naming fallback",i)}return{key:r,title:n,type:s,childKeys:a}}catch(e){return{error:e.message}}}async function _(){try{const e=window.location.href;return E.canParse(e)?{type:"EXTRACT_SUCCESS",payload:await E.parse(document,e)}:{type:"EXTRACT_ERROR",error:"Not a supported Jira Issue URL"}}catch(e){return console.error("Extraction Error:",e),{type:"EXTRACT_ERROR",error:e.message||"Unknown parsing error"}}}function q(e){return new Promise(t=>setTimeout(t,e))}async function F(e){try{console.log(`Content: Starting Epic bulk fetch for ${e}`);const t=await E.fetchEpicChildren(e),r=[e,...t];console.log(`Content: Found ${t.length} children for Epic ${e}`);const n=[];for(let s=0;s<r.length;s++){const c=r[s];chrome.runtime.sendMessage({type:"EPIC_BULK_PROGRESS",payload:{current:s+1,total:r.length*2,key:c}}).catch(()=>{}),console.log(`Content: Fetching ${c} (${s+1}/${r.length})`);const a=await E.parseByKey(c);n.push(a),await q(100)}return console.log(`Content: Successfully fetched ${n.length} items`),{type:"EPIC_BULK_SUCCESS",success:!0,payload:{epicKey:e,items:n}}}catch(t){return console.error("Content: Epic bulk fetch failed",t),{type:"EPIC_BULK_ERROR",success:!1,error:t.message||"Failed to fetch Epic data"}}}
