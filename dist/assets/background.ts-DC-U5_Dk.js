const k=a=>{try{const t=a.replace("#","?");return new URL(t).searchParams.get("access_token")}catch{return null}};class S{scopes=["https://www.googleapis.com/auth/documents","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/userinfo.email"];clientId="342225464153-i3qd0aru6fsna13sg2i0qmvtofnktgmb.apps.googleusercontent.com";async fetchToken(t){console.log(`GoogleAuth: fetchToken called (interactive: ${t})`);const e=await new Promise(o=>{if(typeof chrome>"u"||!chrome.identity||!chrome.identity.getAuthToken){o(null);return}chrome.identity.getAuthToken({interactive:t},n=>{chrome.runtime?.lastError||!n?(console.warn("GoogleAuth: Native getAuthToken failed/returned nothing:",chrome.runtime?.lastError?.message||"No token"),o(null)):o(n)})});return e?(await chrome.storage.local.set({auth_token:e,token_expiry:Date.now()+3500*1e3}),e):t?(console.log("GoogleAuth: Attempting Fallback launchWebAuthFlow..."),new Promise(o=>{const n=chrome.identity.getRedirectURL(),r=`https://accounts.google.com/o/oauth2/auth?client_id=${this.clientId}&response_type=token&redirect_uri=${encodeURIComponent(n)}&scope=${encodeURIComponent(this.scopes.join(" "))}&prompt=consent`;chrome.identity.launchWebAuthFlow({url:r,interactive:!0},s=>{if(chrome.runtime?.lastError||!s)console.error("GoogleAuth: Fallback Auth Failed:",chrome.runtime?.lastError?.message),o(null);else{const c=k(s);c&&chrome.storage.local.set({auth_token:c,token_expiry:Date.now()+3500*1e3}),o(c)}})})):null}async login(){const t=await this.fetchToken(!0);if(!t){const e=chrome.runtime?.lastError?.message;throw new Error(`Authentication failed: ${e||"No token returned"}`)}return t}async getToken(){const t=await chrome.storage.local.get(["auth_token","token_expiry"]),e=t.auth_token,o=t.token_expiry;return e&&o&&o>Date.now()?(console.log("GoogleAuth: Using valid cached token from storage."),e):(console.log("GoogleAuth: Storage token missing/expired. Attempting silent fetch..."),await this.fetchToken(!1))}async getUserInfo(t){const e=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)throw new Error("Failed to fetch user info");return await e.json()}async logout(){await chrome.storage.local.remove(["auth_token","token_expiry","userInfo"]);try{const t=await this.getToken();t&&await new Promise(e=>{chrome.identity.removeCachedAuthToken({token:t},()=>e())})}catch{}console.log("GoogleAuth: Logged out and identity cache cleared.")}}class T{baseUrl="https://docs.googleapis.com/v1/documents";driveUrl="https://www.googleapis.com/drive/v3/files";async createDoc(t,e,o){const n=await fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({title:t})});if(!n.ok){const c=await n.text();throw new Error(`Failed to create doc (${n.status}): ${c}`)}const s=(await n.json()).documentId;return o&&await this.moveToFolder(s,o,e),s}async moveToFolder(t,e,o){const s=((await(await fetch(`${this.driveUrl}/${t}?fields=parents`,{headers:{Authorization:`Bearer ${o}`}})).json()).parents||[]).join(",");await fetch(`${this.driveUrl}/${t}?addParents=${e}&removeParents=${s}`,{method:"PATCH",headers:{Authorization:`Bearer ${o}`}})}async listDocs(t){const o=await fetch(`${this.driveUrl}?q=${encodeURIComponent("mimeType='application/vnd.google-apps.document' and trashed=false")}&fields=files(id,name)`,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok){const r=await o.text();throw new Error(`Failed to list docs (${o.status}): ${r}`)}return(await o.json()).files||[]}async searchDocs(t,e){const o=`mimeType='application/vnd.google-apps.document' and name contains '${e.replace(/'/g,"\\'")}' and trashed=false`,n=await fetch(`${this.driveUrl}?q=${encodeURIComponent(o)}&fields=files(id,name)&orderBy=modifiedTime desc`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok){const s=await n.text();throw new Error(`Failed to search docs (${n.status}): ${s}`)}return(await n.json()).files||[]}async listFolders(t,e){let o="mimeType='application/vnd.google-apps.folder' and trashed=false";e&&(o+=` and '${e}' in parents`);const n=await fetch(`${this.driveUrl}?q=${encodeURIComponent(o)}&fields=files(id,name)&orderBy=name`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok){const s=await n.text();throw new Error(`Failed to list folders (${n.status}): ${s}`)}return(await n.json()).files||[]}async syncItem(t,e,o){const n=await this.getDoc(t,o),r=this.findSectionRange(n,e.key);console.log("DocsSyncService: Syncing item",e.key),e.status.toLowerCase();const s=e.comments&&e.comments.length>0?e.comments.map(g=>`[${g.timestamp||"Unknown"}] ${g.author}: ${g.body.replace(/\*\*/g,"")}`).join(`
`):"_No recent comments_",c=[`Status: ${e.status}`,`Reporter: ${e.reporter||"N/A"}`,`Assignee: ${e.assignee||"Unassigned"}`,`Sprint History: ${e.sprints&&e.sprints.length>0?e.sprints.join(", "):"No Sprints"}`,`T-Shirt Size: ${e.tShirtSize||"N/A"}`,`Work Type: ${e.workType||"N/A"}`,`Business Team: ${e.businessTeam||"N/A"}`,`Business Objective: ${e.businessObjective||"N/A"}`,`Impact: ${e.impact||"N/A"}`,`Labels: ${e.labels&&e.labels.length>0?e.labels.join(", "):"None"}`,`Synced: ${new Date().toLocaleString()}`,`Created: ${e.createdDate?new Date(e.createdDate).toLocaleString():"N/A"} | Updated: ${e.updatedDate?new Date(e.updatedDate).toLocaleString():"N/A"}`].join(`
`);let w="";e.linkedIssues&&e.linkedIssues.length>0&&(w=`
Linked Tickets:
`+e.linkedIssues.map(g=>`* ${g.key}: ${g.title}
  - T-Shirt: ${g.tShirtSize||"N/A"}
  - Context: ${g.rationale||"N/A"}`).join(`
`));const l=`${e.key}: ${e.title}`,d=`${c}
Link: ${e.url}

Description
${e.description}
${w}

Latest Comments
${s}

---
`,u=[];let i;r?(i=r.startIndex,u.push({deleteContentRange:{range:{startIndex:r.startIndex,endIndex:r.endIndex}}})):(i=n.body.content[n.body.content.length-1].endIndex-1,u.push({insertText:{location:{index:i},text:`
`}}),i+=1),u.push({insertText:{location:{index:i},text:l+`
`}}),u.push({updateParagraphStyle:{range:{startIndex:i,endIndex:i+l.length},paragraphStyle:{namedStyleType:"HEADING_1"},fields:"namedStyleType"}}),i+=l.length+1,u.push({insertText:{location:{index:i},text:d}}),u.push({updateParagraphStyle:{range:{startIndex:i,endIndex:i+d.length},paragraphStyle:{namedStyleType:"NORMAL_TEXT"},fields:"namedStyleType"}}),await this.batchUpdate(t,o,u)}async getDoc(t,e){const o=await fetch(`${this.baseUrl}/${t}`,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok){const n=await o.text();throw console.error(`DocsSync API Error [Get]: ${o.status}`,n),new Error(`Failed to fetch doc (${o.status}): ${n}`)}return await o.json()}async batchUpdate(t,e,o){const n=await fetch(`${this.baseUrl}/${t}:batchUpdate`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({requests:o})});if(!n.ok){const r=await n.text();throw console.error(`DocsSync API Error [BatchUpdate]: ${n.status}`,r),new Error(`Failed to update doc (${n.status}): ${r}`)}}findSectionRange(t,e){const o=t.body.content;let n=-1,r=-1;for(let s=0;s<o.length;s++){const c=o[s];if(!c.paragraph)continue;const l=(c.paragraph.elements||[]).map(i=>i.textRun?.content||"").join("").trim(),d=c.paragraph.paragraphStyle?.namedStyleType;if((d==="HEADING_1"||d==="HEADING_2")&&l.includes(e)){n=c.startIndex,console.log(`DocsSync: Found section for ${e} at index ${n}`);continue}if(n!==-1){const i=c.paragraph.paragraphStyle?.namedStyleType;if(i==="HEADING_1"||i==="HEADING_2"||l==="---"||l==="***"){r=l==="---"||l==="***"?c.endIndex:c.startIndex;break}}}return n!==-1&&r===-1&&(r=o[o.length-1].endIndex-1),n!==-1?{startIndex:n,endIndex:r}:null}}function f(a){return a?{id:a.id||a.docId,name:a.name}:null}console.log("Jira to NotebookLM: Background service worker loaded");const m=async(a,t)=>{if(a.includes(".chromiumapp.org/")&&a.includes("access_token=")){console.log("Background: Intercepted Token URL:",a);try{const e=a.replace("#","?"),o=new URL(e),n=o.searchParams.get("access_token"),r=o.searchParams.get("expires_in");if(n){const s=Date.now()+parseInt(r||"3599")*1e3;await chrome.storage.local.set({auth_token:n,token_expiry:s}),console.log("Background: Auth successful. Notifying popup and closing tab."),chrome.runtime.sendMessage({type:"AUTH_SUCCESS"}).catch(()=>{}),setTimeout(()=>{chrome.tabs.remove(t).catch(()=>{})},100)}}catch(e){console.error("Background: Token extraction error:",e)}}};chrome.tabs.onUpdated.addListener((a,t,e)=>{t.url&&m(t.url,a)});chrome.tabs.onCreated.addListener(a=>{a.id&&a.url&&m(a.url,a.id)});chrome.webNavigation.onBeforeNavigate.addListener(a=>{a.frameId===0&&m(a.url,a.tabId)});chrome.webNavigation.onCommitted.addListener(a=>{a.frameId===0&&m(a.url,a.tabId)});const h=new S,p=new T;chrome.runtime.onMessage.addListener((a,t,e)=>(E(a).then(e).catch(o=>{const n={message:o.message||"Unknown error",name:o.name,stack:o.stack,original:o};console.error("Background Error Detailed:",JSON.stringify(n,null,2)),e({error:o.message||JSON.stringify(o)})}),!0));async function E(a){switch(a.type){case"LOGIN":return console.log("Background: Triggering LOGIN flow..."),await h.login();case"CHECK_AUTH":return await h.getToken();case"LIST_DOCS":{const t=await h.getToken();if(!t)throw new Error("Not authenticated");return await p.listDocs(t)}case"LIST_DRIVE_FOLDERS":{const t=await h.getToken();if(!t)throw new Error("Not authenticated");return await p.listFolders(t,a.payload?.parentId)}case"SEARCH_DOCS":{const t=await h.getToken();if(!t)throw new Error("Not authenticated");return await p.searchDocs(t,a.payload.query)}case"CREATE_DOC":{const t=await h.getToken();if(!t)throw new Error("Not authenticated");return await p.createDoc(a.payload.title,t,a.payload.folderId)}case"GET_CURRENT_ISSUE_KEY":{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.id)throw new Error("No active tab found.");try{const e=await chrome.tabs.sendMessage(t.id,{type:"GET_ISSUE_KEY"});if(e.error)throw new Error(e.error);return e}catch(e){throw console.warn("Background: Content script not found on this page. This is normal if not on Jira.",e),new Error("Please open the extension on a Jira issue page.")}}case"GET_SELECTED_DOC":{const t=await chrome.storage.local.get("selectedDoc");return f(t.selectedDoc)}case"SET_SELECTED_DOC":return await chrome.storage.local.set({selectedDoc:a.payload}),!0;case"SYNC_CURRENT_PAGE":return await $();case"SYNC_EPIC":return await D(a.payload.epicKey);case"GET_ISSUE_DOC_LINK":{const{issueKey:t}=a.payload;return(await y())[t]||null}case"CLEAR_ISSUE_DOC_LINK":{const{issueKey:t}=a.payload,e=await y();return delete e[t],await chrome.storage.local.set({issueDocLinks:e}),!0}case"GET_LAST_SYNC":{const{issueKey:t}=a.payload;return((await chrome.storage.local.get("issueSyncTimes")).issueSyncTimes||{})[t]||null}case"LOGOUT":return await h.logout()}}async function y(){const t=(await chrome.storage.local.get("issueDocLinks")).issueDocLinks||{},e={};for(const o in t){const n=f(t[o]);n&&(e[o]=n)}return e}async function $(){try{const a=await h.getToken();if(!a)throw new Error("Not authenticated");const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.id)throw new Error("No active tab");const e=await chrome.tabs.sendMessage(t.id,{type:"EXTRACT_ISSUE"});if(e.type==="EXTRACT_ERROR")throw new Error(e.error);if(e.type!=="EXTRACT_SUCCESS")throw new Error("Unexpected response type from content script");const o=e.payload.key,n=await y();let r;if(n[o])r=n[o];else{const{selectedDoc:w}=await chrome.storage.local.get("selectedDoc");if(!w)throw new Error("No target Document selected. Select one to link this issue.");r=w,n[o]=r,await chrome.storage.local.set({issueDocLinks:n})}await p.syncItem(r.id,e.payload,a),console.log(`Background: Sync successful for ${o} to ${r.name}`);const c=(await chrome.storage.local.get("issueSyncTimes")).issueSyncTimes||{};return c[o]={status:"success",time:Date.now(),message:`Synced to ${r.name}`},await chrome.storage.local.set({issueSyncTimes:c,lastSyncType:"single"}),{success:!0,key:o,id:r.id}}catch(a){throw console.error("Background Sync Error:",a),a}}async function D(a){try{const t=await h.getToken();if(!t)throw new Error("Google Docs not authenticated. Please disconnect and reconnect.");const e=await y();let o=e[a];if(!o){const u=(await chrome.storage.local.get("selectedDoc")).selectedDoc;if(!u)throw new Error("No target Document selected. Link the Epic first.");o=u,e[a]=o,await chrome.storage.local.set({issueDocLinks:e})}const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n?.id)throw new Error("No active tab");const r=await chrome.tabs.sendMessage(n.id,{type:"FETCH_EPIC_BULK",payload:{epicKey:a}});if(r.type==="EXTRACT_ERROR")throw new Error(r.error);if(r.type!=="EPIC_BULK_SUCCESS")throw new Error("Expected EPIC_BULK_SUCCESS");const s=r.payload.items;console.log(`Background: Found ${s.length} issues in Epic ${a}`);let c=0;for(const d of s)c++,console.log(`Background: Syncing progress ${c}/${s.length} - ${d.key}`),chrome.runtime.sendMessage({type:"EPIC_BULK_PROGRESS",payload:{current:c,total:s.length,key:d.key,stage:"Syncing"}}).catch(()=>{}),await p.syncItem(o.id,d,t),e[d.key]||(e[d.key]=o,await chrome.storage.local.set({issueDocLinks:e}));const l=(await chrome.storage.local.get("issueSyncTimes")).issueSyncTimes||{};return l[a]={status:"success",time:Date.now(),message:`Bulk synced ${c} issues to ${o.name}`},await chrome.storage.local.set({issueSyncTimes:l,lastSyncType:"bulk"}),{success:!0,count:c,key:a,id:o.id}}catch(t){throw console.error("Background Epic Sync Error:",t),t}}
