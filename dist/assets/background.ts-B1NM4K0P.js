const N=n=>{try{const e=n.replace("#","?");return new URL(e).searchParams.get("access_token")}catch{return null}};class b{scopes=["https://www.googleapis.com/auth/documents","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/userinfo.email"];clientId="342225464153-i3qd0aru6fsna13sg2i0qmvtofnktgmb.apps.googleusercontent.com";async fetchToken(e){console.log(`GoogleAuth: fetchToken called (interactive: ${e})`);const o=await new Promise(t=>{if(typeof chrome>"u"||!chrome.identity||!chrome.identity.getAuthToken){t(null);return}chrome.identity.getAuthToken({interactive:e},a=>{chrome.runtime?.lastError||!a?(console.warn("GoogleAuth: Native getAuthToken failed/returned nothing:",chrome.runtime?.lastError?.message||"No token"),t(null)):t(a)})});return o?(await chrome.storage.local.set({auth_token:o,token_expiry:Date.now()+3500*1e3}),o):e?(console.log("GoogleAuth: Attempting Fallback launchWebAuthFlow..."),new Promise(t=>{const a=chrome.identity.getRedirectURL(),r=`https://accounts.google.com/o/oauth2/auth?client_id=${this.clientId}&response_type=token&redirect_uri=${encodeURIComponent(a)}&scope=${encodeURIComponent(this.scopes.join(" "))}&prompt=consent`;chrome.identity.launchWebAuthFlow({url:r,interactive:!0},i=>{if(chrome.runtime?.lastError||!i)console.error("GoogleAuth: Fallback Auth Failed:",chrome.runtime?.lastError?.message),t(null);else{const c=N(i);c&&chrome.storage.local.set({auth_token:c,token_expiry:Date.now()+3500*1e3}),t(c)}})})):null}async login(){const e=await this.fetchToken(!0);if(!e){const o=chrome.runtime?.lastError?.message;throw new Error(`Authentication failed: ${o||"No token returned"}`)}return e}async getToken(){const e=await chrome.storage.local.get(["auth_token","token_expiry"]),o=e.auth_token,t=e.token_expiry;return o&&t&&t>Date.now()?(console.log("GoogleAuth: Using valid cached token from storage."),o):(console.log("GoogleAuth: Storage token missing/expired. Attempting silent fetch..."),await this.fetchToken(!1))}async getUserInfo(e){const o=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(!o.ok)throw new Error("Failed to fetch user info");return await o.json()}async logout(){await chrome.storage.local.remove(["auth_token","token_expiry","userInfo"]);try{const e=await this.getToken();e&&await new Promise(o=>{chrome.identity.removeCachedAuthToken({token:e},()=>o())})}catch{}console.log("GoogleAuth: Logged out and identity cache cleared.")}}class I{baseUrl="https://docs.googleapis.com/v1/documents";driveUrl="https://www.googleapis.com/drive/v3/files";async createDoc(e,o,t){const a=await fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({title:e})});if(!a.ok){const c=await a.text();throw new Error(`Failed to create doc (${a.status}): ${c}`)}const i=(await a.json()).documentId;return t&&await this.moveToFolder(i,t,o),i}async moveToFolder(e,o,t){const i=((await(await fetch(`${this.driveUrl}/${e}?fields=parents`,{headers:{Authorization:`Bearer ${t}`}})).json()).parents||[]).join(",");await fetch(`${this.driveUrl}/${e}?addParents=${o}&removeParents=${i}`,{method:"PATCH",headers:{Authorization:`Bearer ${t}`}})}async listDocs(e){const t=await fetch(`${this.driveUrl}?q=${encodeURIComponent("mimeType='application/vnd.google-apps.document' and trashed=false")}&fields=files(id,name)`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok){const r=await t.text();throw new Error(`Failed to list docs (${t.status}): ${r}`)}return(await t.json()).files||[]}async searchDocs(e,o){const t=`mimeType='application/vnd.google-apps.document' and name contains '${o.replace(/'/g,"\\'")}' and trashed=false`,a=await fetch(`${this.driveUrl}?q=${encodeURIComponent(t)}&fields=files(id,name)&orderBy=modifiedTime desc`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok){const i=await a.text();throw new Error(`Failed to search docs (${a.status}): ${i}`)}return(await a.json()).files||[]}async listFolders(e,o){let t="mimeType='application/vnd.google-apps.folder' and trashed=false";o&&(t+=` and '${o}' in parents`);const a=await fetch(`${this.driveUrl}?q=${encodeURIComponent(t)}&fields=files(id,name)&orderBy=name`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok){const i=await a.text();throw new Error(`Failed to list folders (${a.status}): ${i}`)}return(await a.json()).files||[]}async syncItem(e,o,t){return this.syncItems(e,[o],t)}async syncItems(e,o,t){const a=await this.getDoc(e,t),r=a.body.content[a.body.content.length-1].endIndex;console.log(`DocsSyncService: Wiping and syncing ${o.length} items to ${e}`);const i=[];r>2&&i.push({deleteContentRange:{range:{startIndex:1,endIndex:r-1}}});for(const s of o){const m=s.comments&&s.comments.length>0?s.comments.map(d=>`[${d.timestamp||"Unknown"}] ${d.author}: ${d.body.replace(/\*\*/g,"")}`).join(`
`):"_No recent comments_",p=[`Status: ${s.status}`,`Reporter: ${s.reporter||"N/A"}`,`Assignee: ${s.assignee||"Unassigned"}`,`Sprint History: ${s.sprints&&s.sprints.length>0?s.sprints.join(", "):"No Sprints"}`,`T-Shirt Size: ${s.tShirtSize||"N/A"}`,`Work Type: ${s.workType||"N/A"}`,`Business Team: ${s.businessTeam||"N/A"}`,`Business Objective: ${s.businessObjective||"N/A"}`,`Impact: ${s.impact||"N/A"}`,`Labels: ${s.labels&&s.labels.length>0?s.labels.join(", "):"None"}`,`Synced: ${new Date().toLocaleString()}`,`Created: ${s.createdDate?new Date(s.createdDate).toLocaleString():"N/A"} | Updated: ${s.updatedDate?new Date(s.updatedDate).toLocaleString():"N/A"}`].join(`
`);let y="";s.linkedIssues&&s.linkedIssues.length>0&&(y=`
Linked Tickets:
`+s.linkedIssues.map(d=>`* ${d.key}: ${d.title}
  - T-Shirt: ${d.tShirtSize||"N/A"}
  - Context: ${d.rationale||"N/A"}`).join(`
`)),`${s.key}${s.title}`,`${p}${s.url}${s.description}${y}${m}`}let c="";const h=[];for(const s of o){const m=s.comments&&s.comments.length>0?s.comments.map(l=>`[${l.timestamp||"Unknown"}] ${l.author}: ${l.body.replace(/\*\*/g,"")}`).join(`
`):"_No recent comments_",p=[`Status: ${s.status}`,`Reporter: ${s.reporter||"N/A"}`,`Assignee: ${s.assignee||"Unassigned"}`,`Sprint History: ${s.sprints&&s.sprints.length>0?s.sprints.join(", "):"No Sprints"}`,`T-Shirt Size: ${s.tShirtSize||"N/A"}`,`Work Type: ${s.workType||"N/A"}`,`Business Team: ${s.businessTeam||"N/A"}`,`Business Objective: ${s.businessObjective||"N/A"}`,`Impact: ${s.impact||"N/A"}`,`Labels: ${s.labels&&s.labels.length>0?s.labels.join(", "):"None"}`,`Synced: ${new Date().toLocaleString()}`,`Created: ${s.createdDate?new Date(s.createdDate).toLocaleString():"N/A"} | Updated: ${s.updatedDate?new Date(s.updatedDate).toLocaleString():"N/A"}`].join(`
`);let y="";s.linkedIssues&&s.linkedIssues.length>0&&(y=`
Linked Tickets:
`+s.linkedIssues.map(l=>{const C=l.comments&&l.comments.length>0?`
    Comments:
    `+l.comments.map($=>`[${$.timestamp}] ${$.author}: ${$.body}`).join(`
    `):"";return`* ${l.key}: ${l.title}
  - Status: ${l.status||"N/A"} | Priority: ${l.priority||"N/A"}
  - Description: ${l.description||"No description"}
  - Link: ${l.url}${C}`}).join(`

`));const d=`${s.key}: ${s.title}
`,E=c.length+1;c+=d;const T=c.length+1;h.push({start:E,end:T,type:"HEADING_1"});const D=`${p}
Link: ${s.url}

Description
${s.description}
${y}

--------------------------------------------------
Latest Comments
${m}

---

`,_=c.length+1;c+=D;const A=c.length+1;h.push({start:_,end:A,type:"NORMAL_TEXT"})}i.push({insertText:{location:{index:1},text:c}});for(const s of h)i.push({updateParagraphStyle:{range:{startIndex:s.start,endIndex:s.end-1},paragraphStyle:{namedStyleType:s.type},fields:"namedStyleType"}});await this.batchUpdate(e,t,i)}async getDoc(e,o){const t=await fetch(`${this.baseUrl}/${e}`,{headers:{Authorization:`Bearer ${o}`}});if(!t.ok){const a=await t.text();throw console.error(`DocsSync API Error [Get]: ${t.status}`,a),new Error(`Failed to fetch doc (${t.status}): ${a}`)}return await t.json()}async batchUpdate(e,o,t){const a=await fetch(`${this.baseUrl}/${e}:batchUpdate`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({requests:t})});if(!a.ok){const r=await a.text();throw console.error(`DocsSync API Error [BatchUpdate]: ${a.status}`,r),new Error(`Failed to update doc (${a.status}): ${r}`)}}}function S(n){return n?{id:n.id||n.docId,name:n.name}:null}console.log("Jira to NotebookLM: Background service worker loaded");const f=async(n,e)=>{if(n.includes(".chromiumapp.org/")&&n.includes("access_token=")){console.log("Background: Intercepted Token URL:",n);try{const o=n.replace("#","?"),t=new URL(o),a=t.searchParams.get("access_token"),r=t.searchParams.get("expires_in");if(a){const i=Date.now()+parseInt(r||"3599")*1e3;await chrome.storage.local.set({auth_token:a,token_expiry:i}),console.log("Background: Auth successful. Notifying popup and closing tab."),chrome.runtime.sendMessage({type:"AUTH_SUCCESS"}).catch(()=>{}),setTimeout(()=>{chrome.tabs.remove(e).catch(()=>{})},100)}}catch(o){console.error("Background: Token extraction error:",o)}}};chrome.tabs.onUpdated.addListener((n,e,o)=>{e.url&&f(e.url,n)});chrome.tabs.onCreated.addListener(n=>{n.id&&n.url&&f(n.url,n.id)});chrome.webNavigation.onBeforeNavigate.addListener(n=>{n.frameId===0&&f(n.url,n.tabId)});chrome.webNavigation.onCommitted.addListener(n=>{n.frameId===0&&f(n.url,n.tabId)});const g=new b,w=new I;chrome.runtime.onMessage.addListener((n,e,o)=>(U(n).then(o).catch(t=>{const a={message:t.message||"Unknown error",name:t.name,stack:t.stack,original:t};console.error("Background Error Detailed:",JSON.stringify(a,null,2)),o({error:t.message||JSON.stringify(t)})}),!0));async function U(n){switch(n.type){case"LOGIN":return console.log("Background: Triggering LOGIN flow..."),await g.login();case"CHECK_AUTH":return await g.getToken();case"LIST_DOCS":{const e=await g.getToken();if(!e)throw new Error("Not authenticated");return await w.listDocs(e)}case"LIST_DRIVE_FOLDERS":{const e=await g.getToken();if(!e)throw new Error("Not authenticated");return await w.listFolders(e,n.payload?.parentId)}case"SEARCH_DOCS":{const e=await g.getToken();if(!e)throw new Error("Not authenticated");return await w.searchDocs(e,n.payload.query)}case"CREATE_DOC":{const e=await g.getToken();if(!e)throw new Error("Not authenticated");return await w.createDoc(n.payload.title,e,n.payload.folderId)}case"GET_CURRENT_ISSUE_KEY":{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab found.");try{const o=await chrome.tabs.sendMessage(e.id,{type:"GET_ISSUE_KEY"});if(o.error)throw new Error(o.error);return o}catch(o){throw console.warn("Background: GET_CURRENT_ISSUE_KEY failed",o),o.message?.includes("Could not establish connection")||o.message?.includes("context invalidated")?new Error("Extension updated. Please refresh your Jira page to continue."):new Error("Please open the extension on a Jira issue page.")}}case"GET_SELECTED_DOC":{const e=await chrome.storage.local.get("selectedDoc");return S(e.selectedDoc)}case"SET_SELECTED_DOC":return await chrome.storage.local.set({selectedDoc:n.payload}),!0;case"SYNC_CURRENT_PAGE":return await L();case"SYNC_EPIC":return await B(n.payload.epicKey);case"GET_ISSUE_DOC_LINK":{const{issueKey:e}=n.payload;return(await k())[e]||null}case"CLEAR_ISSUE_DOC_LINK":{const{issueKey:e}=n.payload,o=await k();return delete o[e],await chrome.storage.local.set({issueDocLinks:o}),!0}case"GET_LAST_SYNC":{const{issueKey:e}=n.payload;return((await chrome.storage.local.get("issueSyncTimes")).issueSyncTimes||{})[e]||null}case"LOGOUT":return await g.logout()}}async function k(){const e=(await chrome.storage.local.get("issueDocLinks")).issueDocLinks||{},o={};for(const t in e){const a=S(e[t]);a&&(o[t]=a)}return o}async function u(n){await chrome.storage.local.set({activeSyncState:n}),chrome.runtime.sendMessage({type:"SYNC_STATE_UPDATE",payload:n}).catch(()=>{})}async function L(){try{const n=await g.getToken();if(!n)throw new Error("Not authenticated");const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab");await u({isSyncing:!0,progress:10,status:"Initializing...",key:"pending"});const o=await chrome.tabs.sendMessage(e.id,{type:"EXTRACT_ISSUE"});if(o.type==="EXTRACT_ERROR")throw new Error(o.error);if(o.type!=="EXTRACT_SUCCESS")throw new Error("Unexpected response type from content script");const t=o.payload.key;await u({isSyncing:!0,progress:30,status:`Fetched ${t}`,key:t});const a=await k();let r;if(a[t])r=a[t];else{const{selectedDoc:s}=await chrome.storage.local.get("selectedDoc");if(!s)throw new Error("No target Document selected. Select one to link this issue.");r=s,a[t]=r,await chrome.storage.local.set({issueDocLinks:a})}await u({isSyncing:!0,progress:60,status:`Syncing ${t} to Google Docs...`,key:t}),await w.syncItem(r.id,o.payload,n),console.log(`Background: Sync successful for ${t} to ${r.name}`);const c=(await chrome.storage.local.get("issueSyncTimes")).issueSyncTimes||{},h={status:"success",time:Date.now(),message:`Synced to ${r.name}`};return c[t]=h,await chrome.storage.local.set({issueSyncTimes:c,lastSyncType:"single"}),await u({isSyncing:!1,progress:100,status:"Complete!",key:t,result:h}),{success:!0,key:t,id:r.id}}catch(n){throw console.error("Background Sync Error:",n),await u({isSyncing:!1,progress:0,status:`Error: ${n.message}`,result:{status:"error",message:n.message,time:Date.now()}}),n}}async function B(n){try{const e=await g.getToken();if(!e)throw new Error("Google Docs not authenticated. Please disconnect and reconnect.");await u({isSyncing:!0,progress:5,status:"Initializing Bulk Sync...",key:n});const o=await k();let t=o[n];if(!t){const p=(await chrome.storage.local.get("selectedDoc")).selectedDoc;if(!p)throw new Error("No target Document selected. Link the Epic first.");t=p,o[n]=t,await chrome.storage.local.set({issueDocLinks:o})}const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!a?.id)throw new Error("No active tab");const r=await chrome.tabs.sendMessage(a.id,{type:"FETCH_EPIC_BULK",payload:{epicKey:n}});if(r.type==="EXTRACT_ERROR")throw new Error(r.error);if(r.type!=="EPIC_BULK_SUCCESS")throw new Error("Expected EPIC_BULK_SUCCESS");const i=r.payload.items;console.log(`Background: Found ${i.length} issues in Epic ${n}`),await u({isSyncing:!0,progress:60,status:`Gathered ${i.length} items. Writing to Google Doc...`,key:n}),await w.syncItems(t.id,i,e);for(const m of i)o[m.key]||(o[m.key]=t);await chrome.storage.local.set({issueDocLinks:o});const h=(await chrome.storage.local.get("issueSyncTimes")).issueSyncTimes||{},s={status:"success",time:Date.now(),message:`Bulk synced ${i.length} issues to ${t.name}`};return h[n]=s,await chrome.storage.local.set({issueSyncTimes:h,lastSyncType:"bulk"}),await u({isSyncing:!1,progress:100,status:"Bulk Sync Complete!",key:n,result:s}),{success:!0,count:i.length,key:n,id:t.id}}catch(e){throw console.error("Background Epic Sync Error:",e),await u({isSyncing:!1,progress:0,status:`Bulk Sync Error: ${e.message}`,result:{status:"error",message:e.message,time:Date.now()}}),e}}chrome.runtime.onMessage.addListener(n=>{if(n.type==="EPIC_BULK_PROGRESS"){const{current:e,total:o,key:t}=n.payload,a=5+Math.floor(e/o*55);u({isSyncing:!0,progress:a,status:`Processing ${t} (${e}/${o})...`,key:t})}});
