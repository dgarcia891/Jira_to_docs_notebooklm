(function(){function b(e){if(!e)return"";let t="";switch(e.type){case"doc":case"paragraph":case"bulletList":case"orderedList":case"listItem":case"blockquote":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=b(r)}),e.type!=="doc"&&(t+=`
`));break;case"text":t+=e.text||"";break;case"hardBreak":t+=`
`;break;case"inlineCard":case"blockCard":case"embedCard":e.attrs&&e.attrs.url?t+=` [Link: ${e.attrs.url}] `:t+=" [Linked Item] ";break;case"mention":e.attrs&&e.attrs.text?t+=` ${e.attrs.text} `:t+=" @user ";break;case"extension":case"bodiedExtension":case"inlineExtension":t+=` [Embedded Content: ${e.attrs?.extensionKey||"Extension"}] `;break;case"table":case"tableRow":case"tableHeader":case"tableCell":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=b(r),(e.type==="tableCell"||e.type==="tableHeader")&&(t+=" | ")}),e.type==="tableRow"&&(t+=`
`));break;default:e.content&&Array.isArray(e.content)&&e.content.forEach(r=>{t+=b(r)});break}return t}function $(e,t){if(!e)return"";const r=["Sort in ascending order","Sort in descending order","Sort A to Z","Sort Z to A","More actions for","â€¢",t,"Assign to me","Assign to","None","Add a descriptionâ€¦","Add a description"];let a=e;r.forEach(s=>{a=a.replace(new RegExp(s,"gi"),"")}),a=a.replace(/Sort A to Z.*/gi,""),a=a.replace(/More actions for.*/gi,"");const i=a.trim().split(/\s+/),o=[];for(let s=0;s<i.length;s++)(s===0||i[s].toLowerCase()!==i[s-1].toLowerCase())&&o.push(i[s]);return o.join(" ")||"Pending"}function v(e){let t=I(e);return/add\s+a\s+description/i.test(t)?"":t}function x(e){if(e.toLowerCase()==="unassigned")return"Unassigned ðŸ‘¤";let t=e.replace(/^Assignee/i,"").trim();return["Sort A to Z","More actions for Assignee","Sort A to ZMore actions for Assignee","â€¢"].forEach(a=>t=t.replace(a,"")),$(t,"Assignee").trim()}function I(e){return!e||e==="_No description provided_"?"_No description provided_":e.replace(/<br\s*\/?>/gi,`
`).replace(/<\/p>/gi,`

`).replace(/<[^>]*>/g,"").replace(/([.:])([A-Z])/g,`$1

$2`).replace(/\n{3,}/g,`

`).trim()}function U(e){const t=e.match(/browse\/([A-Z]+-\d+)/);return t?t[1]:""}function j(e){const t=e.toLowerCase();return t.includes("bug")?"bug":t.includes("story")?"story":t.includes("epic")?"epic":t.includes("task")?"task":"other"}function k(e,t){const r=t.createElement("div");r.innerHTML=e,r.querySelectorAll('[data-node-type="inlineCard"], [data-node-type="blockCard"], .jira-issue-card, .smart-link, [data-testid*="inline-card"], [data-testid*="issue.views.issue-base.content.issue-links"]').forEach(s=>{const n=s.querySelector("a");let l="[Linked Issue]";if(n){const h=(n.getAttribute("href")||"").match(/browse\/([A-Z]+-\d+)/);h?l=` ${h[1]} `:l=` ${n.textContent?.trim()||"Linked Issue"} `}else if(s.getAttribute("data-card-data"))try{const p=JSON.parse(s.getAttribute("data-card-data")||"{}");p.url&&(l=` [${p.url}] `)}catch{}l.length>50&&(l=" [Linked Link] ");const u=t.createTextNode(l);s.parentNode?.replaceChild(u,s)}),r.querySelectorAll("style, script, svg").forEach(s=>s.remove());let o=r.innerText||r.textContent||"";return o=o.replace(/\n\s*\n\s*\n/g,`

`).replace(/[ \t]+/g," "),o.trim()}async function L(e,t,r){console.log(`JiraParser: Discovering children for Epic ${e}...`);const a=await fetch(`${t}/rest/api/3/search/jql`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-Atlassian-Token":"no-check","X-Requested-With":"XMLHttpRequest",...r},body:JSON.stringify({jql:`"parent" = ${e} OR "Epic Link" = ${e} order by created ASC`,fields:["key"],maxResults:100})});if(!a.ok){const o=await a.text().catch(()=>"Unknown error");throw new Error(`Failed to fetch epic children for ${e} (${a.status}): ${o}`)}return(await a.json()).issues.map(o=>o.key)}async function P(e,t,r,a){try{const i=await fetch(`${r}/rest/api/3/issue/${e}?fields=summary,comment,${t["t-shirt size"]||""}`,{headers:{Accept:"application/json",...a}});if(!i.ok)return{key:e,title:"Error fetching",url:`${r}/browse/${e}`};const s=(await i.json()).fields||{},n=t["t-shirt size"],l=n&&(s[n]?.value||s[n]?.name||s[n])||"",u=s.comment?.comments||[],p=u.length>0?T(u[u.length-1].body):"No technical notes recorded.";return{id:e,key:e,title:s.summary||"",tShirtSize:l,rationale:p,url:`${r}/browse/${e}`}}catch{return{key:e,title:"Network Error",url:`${r}/browse/${e}`}}}function T(e){const r=b(e).split(`
`).filter(a=>a.trim().length>0);return r.slice(0,2).join(" ")+(r.length>2?"...":"")}async function R(e,t,r,a){if(!a)return[];try{console.log(`JiraParser: Fetching comments for ${a} via API...`);const i=await fetch(`${e}/rest/api/3/issue/${a}/comment?expand=renderedBody`,{method:"GET",headers:{Accept:"application/json",...t}});if(!i.ok)return console.error(`JiraParser: API Error ${i.status} ${i.statusText}`),i.status===401||i.status===403?[{id:"error-auth",author:"System",body:"Error: Could not access Jira API. Please ensure you are logged in.",timestamp:new Date().toISOString()}]:[];const o=await i.json();return!o.comments||!Array.isArray(o.comments)?[]:o.comments.map((n,l)=>{let u="";if(n.body&&typeof n.body=="object")try{u=b(n.body)}catch{n.renderedBody&&(u=k(n.renderedBody,r))}else n.renderedBody?u=k(n.renderedBody,r):n.body&&typeof n.body=="string"?u=n.body:u="[Content Not Available]";const p=n.author?.displayName||"Unknown User";let h=new Date().toISOString();try{n.created&&(h=new Date(n.created).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{}return{id:n.id||`comment-${l}`,author:p,body:u.trim(),timestamp:h}}).filter(n=>n!==null).reverse()}catch(i){return console.error("JiraParser: API Fetch Exception",i),[{id:"error-exception",author:"System",body:`Error: API Fetch failed. ${i}`,timestamp:new Date().toISOString()}]}}class B{canParse(t){return/atlassian\.net\/(browse\/|jira\/software\/.*selectedIssue=)/.test(t)}baseUrlOverride=null;jiraEmail=null;jiraApiToken=null;setCredentials(t,r){this.jiraEmail=t,this.jiraApiToken=r}setBaseUrl(t){try{const r=new URL(t);this.baseUrlOverride=`${r.protocol}//${r.host}`}catch{this.baseUrlOverride=null}}getApiUrl(t){return this.baseUrlOverride?`${this.baseUrlOverride}${t}`:t}getBaseUrl(){return this.baseUrlOverride||""}getAuthHeaders(){return this.jiraEmail&&this.jiraApiToken?{Authorization:`Basic ${btoa(`${this.jiraEmail}:${this.jiraApiToken}`)}`}:{}}async parse(t,r){this.setBaseUrl(r);let a=U(r);if(a||(a=t.querySelector('[data-testid="issue.views.issue-base.foundation.breadcrumbs.breadcrumb-current-issue-container"] a')?.textContent?.trim()||""),!a)throw new Error("Could not extract Issue Key");return this.parseByKey(a,t)}async parseByKey(t,r){console.log(`JiraParser: Fetching issue ${t} data via API...`);let a={};try{const c=await fetch(this.getApiUrl("/rest/api/3/field"),{headers:{Accept:"application/json",...this.getAuthHeaders()}});c.ok&&(await c.json()).forEach(d=>{a[d.name.toLowerCase()]=d.id})}catch(c){console.warn("JiraParser: Field discovery failed",c)}const i=await fetch(this.getApiUrl(`/rest/api/3/issue/${t}`),{method:"GET",headers:{Accept:"application/json",...this.getAuthHeaders()}});if(!i.ok)throw new Error(`JiraParser: API Error ${i.status} fetching issue ${t}`);const s=(await i.json()).fields||{},n=c=>{const d=c.map(g=>g.toLowerCase()).map(g=>a[g]).filter(g=>g!==void 0);for(const g of d){const f=s[g];if(f!=null){if(typeof f=="object")return f.value?f.value:f.name?f.name:JSON.stringify(f);if(String(f).trim()!=="")return String(f)}}return"N/A"},l=s.issuetype?.name||"other",u=j(l),p=`${this.getBaseUrl()||window.location.origin}/browse/${t}`,h=await R(this.getBaseUrl(),this.getAuthHeaders(),r||null,t);let m=n(["t-shirt size","tshirt","sizing","size","et - size"]);if(m==="N/A"){const c=Object.keys(s).filter(y=>y.startsWith("customfield_"));for(const y of c){const d=s[y];if(d&&typeof d=="object"&&d.value&&/^(XS|S|M|L|XL|XXL)$/i.test(d.value)){m=d.value;break}}}if(m==="N/A"&&h.length>0){const c=/estimated as (XS|S|M|L|XL|XXL)/i;for(const y of h){const d=y.body.match(c);if(d){m=d[1].toUpperCase();break}}}let E=[];const C=s.issuelinks||[],S=s.subtasks||[],A=[...C.map(c=>(c.outwardIssue||c.inwardIssue)?.key),...S.map(c=>c.key)].filter(Boolean).slice(0,10);return A.length>0&&(E=await Promise.all(A.map(c=>P(c,a,this.getBaseUrl(),this.getAuthHeaders())))),{id:t,source:"jira",key:t,title:s.summary||"",description:v(s.description?b(s.description):""),status:s.status?.name||"Pending",type:u,priority:s.priority?.name||"Medium",assignee:x(s.assignee?.displayName||"Unassigned"),reporter:s.reporter?.displayName||"Unknown",labels:s.labels||[],url:p,comments:h,createdDate:s.created,updatedDate:s.updated,sprints:s[a.sprint]?.map(c=>c.name)||[],tShirtSize:m,workType:n(["work type","work item type"]),businessTeam:n(["requesting business team","team"]),businessObjective:n(["business objective","goal","business value"]),impact:n(["et - impact","impact","level","severity","class"]),linkedIssues:E.filter(Boolean),metadata:s}}async fetchEpicChildren(t){return L(t,this.getBaseUrl(),this.getAuthHeaders())}}console.log("Jira to NotebookLM: Content script loaded");const w=new B;chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="EXTRACT_ISSUE")return O().then(r),!0;if(e.type==="GET_ISSUE_KEY")return N().then(r),!0;if(e.type==="FETCH_EPIC_BULK")return q(e.payload.epicKey).then(r),!0});async function N(){try{const e=window.location.href;if(!w.canParse(e))return{error:"Not a supported Jira Issue URL"};const t=e.match(/browse\/([A-Z]+-\d+)/),r=t?t[1]:void 0,a=document.querySelector("h1")?.innerText||document.title;let i="";const o=document.querySelector('[data-testid="issue.views.field.issue-type.common.ui.issue-type-field-view"] [data-testid*="issue-type-icon"]');if(o&&(i=o.textContent?.trim()||""),i||document.querySelector('img[alt*="Epic"]')&&(i="Epic"),i||document.querySelector('[aria-label*="Epic"]')&&(i="Epic"),!i){const n=document.querySelectorAll('[data-testid*="issue-type"]');for(const l of n)if((l.textContent?.trim()||"").toLowerCase().includes("epic")){i="Epic";break}}if(!i){const n=document.querySelector('[data-testid="issue-field-summary.ui.issue-field-summary-inline-edit--trigger"]');if(n){const l=n.querySelector('span[data-testid*="issue-type-icon"]');l?i=l.textContent?.trim()||"":i=n.textContent?.trim()||""}}let s=[];if(i.toLowerCase().includes("epic")&&r)try{console.log(`Content: Epic detected (${r}), fetching child keys for dynamic naming...`),s=await w.fetchEpicChildren(r)}catch(n){console.warn("Content: Failed to fetch child keys for naming fallback",n)}return{key:r,title:a,type:i,childKeys:s}}catch(e){return{error:e.message}}}async function O(){try{const e=window.location.href;return w.canParse(e)?{type:"EXTRACT_SUCCESS",payload:await w.parse(document,e)}:{type:"EXTRACT_ERROR",error:"Not a supported Jira Issue URL"}}catch(e){return console.error("Extraction Error:",e),{type:"EXTRACT_ERROR",error:e.message||"Unknown parsing error"}}}function _(e){return new Promise(t=>setTimeout(t,e))}async function q(e){try{console.log(`Content: Starting Epic bulk fetch for ${e}`);const t=await w.fetchEpicChildren(e),r=[e,...t];console.log(`Content: Found ${t.length} children for Epic ${e}`);const a=[];for(let i=0;i<r.length;i++){const o=r[i];chrome.runtime.sendMessage({type:"EPIC_BULK_PROGRESS",payload:{current:i+1,total:r.length*2,key:o}}).catch(()=>{}),console.log(`Content: Fetching ${o} (${i+1}/${r.length})`);const s=await w.parseByKey(o);a.push(s),await _(100)}return console.log(`Content: Successfully fetched ${a.length} items`),{type:"EPIC_BULK_SUCCESS",success:!0,payload:{epicKey:e,items:a}}}catch(t){return console.error("Content: Epic bulk fetch failed",t),{type:"EPIC_BULK_ERROR",success:!1,error:t.message||"Failed to fetch Epic data"}}}
})()