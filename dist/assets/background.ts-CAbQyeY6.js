const k=n=>{try{const t=n.replace("#","?");return new URL(t).searchParams.get("access_token")}catch{return null}};class ${clientId="342225464153-i3qd0aru6fsna13sg2i0qmvtofnktgmb.apps.googleusercontent.com";get redirectUri(){return chrome.identity.getRedirectURL().replace(/\/$/,"")}scopes=["https://www.googleapis.com/auth/documents","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/userinfo.email"].join(" ");async fetchToken(t){const e=new URL("https://accounts.google.com/o/oauth2/v2/auth");e.searchParams.set("client_id",this.clientId),e.searchParams.set("response_type","token"),e.searchParams.set("redirect_uri",this.redirectUri),e.searchParams.set("scope",this.scopes),t&&e.searchParams.set("prompt","select_account consent"),console.log("OAuth Request URL:",e.href),console.log("Redirect URI being sent:",this.redirectUri);try{const o=await chrome.identity.launchWebAuthFlow({url:e.href,interactive:t});if(!o)return null;const a=k(o);return a?(await chrome.storage.local.set({auth_token:a,token_expiry:Date.now()+3500*1e3}),a):null}catch(o){if(t)throw o;return null}}async login(){const t=await this.fetchToken(!0);if(!t)throw new Error("Authentication failed - No token returned");return t}async getToken(){const{auth_token:t,token_expiry:e}=await chrome.storage.local.get(["auth_token","token_expiry"]);return t&&e&&Date.now()<e?t:await this.fetchToken(!1)}async getUserInfo(t){const e=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)throw new Error("Failed to fetch user info");return await e.json()}async logout(){await chrome.storage.local.remove(["auth_token","token_expiry","userInfo"]);try{const{auth_token:t}=await chrome.storage.local.get("auth_token");t&&chrome.identity.removeCachedAuthToken({token:t},()=>{})}catch{}console.log("GoogleAuth: Logged out and identity cache cleared.")}}class T{baseUrl="https://docs.googleapis.com/v1/documents";driveUrl="https://www.googleapis.com/drive/v3/files";async createDoc(t,e,o){const a=await fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({title:t})});if(!a.ok){const c=await a.text();throw new Error(`Failed to create doc (${a.status}): ${c}`)}const s=(await a.json()).documentId;return o&&await this.moveToFolder(s,o,e),s}async moveToFolder(t,e,o){const s=((await(await fetch(`${this.driveUrl}/${t}?fields=parents`,{headers:{Authorization:`Bearer ${o}`}})).json()).parents||[]).join(",");await fetch(`${this.driveUrl}/${t}?addParents=${e}&removeParents=${s}`,{method:"PATCH",headers:{Authorization:`Bearer ${o}`}})}async listDocs(t){const o=await fetch(`${this.driveUrl}?q=${encodeURIComponent("mimeType='application/vnd.google-apps.document' and trashed=false")}&fields=files(id,name)`,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok){const r=await o.text();throw new Error(`Failed to list docs (${o.status}): ${r}`)}return(await o.json()).files||[]}async searchDocs(t,e){const o=`mimeType='application/vnd.google-apps.document' and name contains '${e.replace(/'/g,"\\'")}' and trashed=false`,a=await fetch(`${this.driveUrl}?q=${encodeURIComponent(o)}&fields=files(id,name)&orderBy=modifiedTime desc`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok){const s=await a.text();throw new Error(`Failed to search docs (${a.status}): ${s}`)}return(await a.json()).files||[]}async listFolders(t,e){let o="mimeType='application/vnd.google-apps.folder' and trashed=false";e&&(o+=` and '${e}' in parents`);const a=await fetch(`${this.driveUrl}?q=${encodeURIComponent(o)}&fields=files(id,name)&orderBy=name`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok){const s=await a.text();throw new Error(`Failed to list folders (${a.status}): ${s}`)}return(await a.json()).files||[]}async syncItem(t,e,o){const a=await this.getDoc(t,o),r=this.findSectionRange(a,e.key);console.log("DocsSyncService: Syncing item",e.key,"with",e.comments?.length||0,"comments"),e.status.toLowerCase();const s=e.comments&&e.comments.length>0?e.comments.map(i=>`- **[${i.timestamp||"Unknown"}] ${i.author}:** ${i.body}`).join(`
`):"_No recent comments_",c=[`**Status:** ${e.status}`,`**Reporter:** ${e.reporter||"N/A"}`,`**Assignee:** ${e.assignee||"Unassigned"}`,`**Sprint History:** ${e.sprints&&e.sprints.length>0?e.sprints.join(", "):"No Sprints"}`,`**T-Shirt Size:** ${e.tShirtSize||"N/A"}`,`**Work Type:** ${e.workType||"N/A"}`,`**Business Team:** ${e.businessTeam||"N/A"}`,`**Business Objective:** ${e.businessObjective||"N/A"}`,`**Impact:** ${e.impact||"N/A"}`,`**Labels:** ${e.labels&&e.labels.length>0?e.labels.join(", "):"None"}`,`**Created:** ${e.createdDate?new Date(e.createdDate).toLocaleString():"N/A"} | **Updated:** ${e.updatedDate?new Date(e.updatedDate).toLocaleString():"N/A"}`].join(`
`);let l="";e.linkedIssues&&e.linkedIssues.length>0&&(l=`
### Linked Ticket Context
`+e.linkedIssues.map(i=>`* **${i.key}: ${i.title}**
  - **T-Shirt Size:** ${i.tShirtSize||"N/A"}
  - **Context:** ${i.rationale||"N/A"}
  - [View in Jira](${i.url})`).join(`
`));const y=`${e.key}: ${e.title}`,u=`${y}
${c}
**Link:** ${e.url}

### Description
${e.description}
${l}

### Latest Comments
${s}

---
`,p=[];let h;r?(h=r.startIndex,p.push({deleteContentRange:{range:{startIndex:r.startIndex,endIndex:r.endIndex}}})):(h=a.body.content[a.body.content.length-1].endIndex-1,p.push({insertText:{location:{index:h},text:`
`}}),h+=1),p.push({insertText:{location:{index:h},text:u}});const m=y.length;p.push({updateParagraphStyle:{range:{startIndex:h,endIndex:h+m},paragraphStyle:{namedStyleType:"HEADING_2"},fields:"namedStyleType"}}),await this.batchUpdate(t,o,p)}async getDoc(t,e){const o=await fetch(`${this.baseUrl}/${t}`,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok){const a=await o.text();throw console.error(`DocsSync API Error [Get]: ${o.status}`,a),new Error(`Failed to fetch doc (${o.status}): ${a}`)}return await o.json()}async batchUpdate(t,e,o){const a=await fetch(`${this.baseUrl}/${t}:batchUpdate`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({requests:o})});if(!a.ok){const r=await a.text();throw console.error(`DocsSync API Error [BatchUpdate]: ${a.status}`,r),new Error(`Failed to update doc (${a.status}): ${r}`)}}findSectionRange(t,e){const o=t.body.content;let a=-1,r=-1;for(let s=0;s<o.length;s++){const c=o[s];if(!c.paragraph)continue;const l=c.paragraph.elements.map(u=>u.textRun?.content||"").join("").trim();if(c.paragraph.paragraphStyle?.namedStyleType,l.replace(/^[^a-zA-Z0-9]+/,"").trim().startsWith(e)){a=c.startIndex,console.log(`DocsSync: Found section for ${e} at index ${a}`);continue}if(a!==-1){const u=c.paragraph.paragraphStyle?.namedStyleType;if(u==="HEADING_1"||u==="HEADING_2"||l==="---"||l==="***"){r=l==="---"||l==="***"?c.endIndex:c.startIndex;break}}}return a!==-1&&r===-1&&(r=o[o.length-1].endIndex-1),a!==-1?{startIndex:a,endIndex:r}:null}}console.log("Jira to NotebookLM: Background service worker loaded");const g=async(n,t)=>{if(n.includes(".chromiumapp.org/")&&n.includes("access_token=")){console.log("Background: Intercepted Token URL:",n);try{const e=n.replace("#","?"),o=new URL(e),a=o.searchParams.get("access_token"),r=o.searchParams.get("expires_in");if(a){const s=Date.now()+parseInt(r||"3599")*1e3;await chrome.storage.local.set({auth_token:a,token_expiry:s}),console.log("Background: Auth successful. Notifying popup and closing tab."),chrome.runtime.sendMessage({type:"AUTH_SUCCESS"}).catch(()=>{}),setTimeout(()=>{chrome.tabs.remove(t).catch(()=>{})},100)}}catch(e){console.error("Background: Token extraction error:",e)}}};chrome.tabs.onUpdated.addListener((n,t,e)=>{t.url&&g(t.url,n)});chrome.tabs.onCreated.addListener(n=>{n.id&&n.url&&g(n.url,n.id)});chrome.webNavigation.onBeforeNavigate.addListener(n=>{n.frameId===0&&g(n.url,n.tabId)});chrome.webNavigation.onCommitted.addListener(n=>{n.frameId===0&&g(n.url,n.tabId)});const d=new $,w=new T;chrome.runtime.onMessage.addListener((n,t,e)=>(S(n).then(e).catch(o=>{const a={message:o.message||"Unknown error",name:o.name,stack:o.stack,original:o};console.error("Background Error Detailed:",JSON.stringify(a,null,2)),e({error:o.message||JSON.stringify(o)})}),!0));async function S(n){switch(n.type){case"LOGIN":return await d.login();case"CHECK_AUTH":return await d.getToken();case"LIST_DOCS":{const t=await d.getToken();if(!t)throw new Error("Not authenticated");return await w.listDocs(t)}case"LIST_DRIVE_FOLDERS":{const t=await d.getToken();if(!t)throw new Error("Not authenticated");return await w.listFolders(t,n.payload?.parentId)}case"SEARCH_DOCS":{const t=await d.getToken();if(!t)throw new Error("Not authenticated");return await w.searchDocs(t,n.payload.query)}case"CREATE_DOC":{const t=await d.getToken();if(!t)throw new Error("Not authenticated");return await w.createDoc(n.payload.title,t,n.payload.folderId)}case"GET_CURRENT_ISSUE_KEY":{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.id)throw new Error("No active tab");const e=await chrome.tabs.sendMessage(t.id,{type:"GET_ISSUE_KEY"});if(e.error)throw new Error(e.error);return e.key}case"GET_SELECTED_DOC":return(await chrome.storage.local.get("selectedDoc")).selectedDoc||null;case"SET_SELECTED_DOC":return await chrome.storage.local.set({selectedDoc:n.payload}),!0;case"SYNC_CURRENT_PAGE":return await E();case"GET_ISSUE_DOC_LINK":{const{issueKey:t}=n.payload;return(await f())[t]||null}case"CLEAR_ISSUE_DOC_LINK":{const{issueKey:t}=n.payload,e=await f();return delete e[t],await chrome.storage.local.set({issueDocLinks:e}),!0}case"LOGOUT":return await d.logout()}}async function f(){return(await chrome.storage.local.get("issueDocLinks")).issueDocLinks||{}}async function E(){const n=await d.getToken();if(!n)throw new Error("Not authenticated");const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.id)throw new Error("No active tab");const e=await chrome.tabs.sendMessage(t.id,{type:"EXTRACT_ISSUE"});if(e.type==="EXTRACT_ERROR")throw new Error(e.error);const o=e.payload.key,a=await f();let r;if(a[o])r=a[o];else{const{selectedDoc:s}=await chrome.storage.local.get("selectedDoc");if(!s)throw new Error("No target Document selected. Select one to link this issue.");r=s,a[o]=r,await chrome.storage.local.set({issueDocLinks:a})}return await w.syncItem(r.docId,e.payload,n),{key:o,linkedTo:r.name,commentsCount:e.payload.comments?.length||0}}
