(function(){class z{canParse(e){return/atlassian\.net\/(browse\/|jira\/software\/.*selectedIssue=)/.test(e)}async parse(e,t){let r=this.extractKeyFromUrl(t);if(r||(r=e.querySelector('[data-testid="issue.views.issue-base.foundation.breadcrumbs.breadcrumb-current-issue-container"] a')?.textContent?.trim()||""),!r)throw new Error("Could not extract Issue Key");console.log(`JiraParser: Fetching issue ${r} data via API...`);let n={};try{const o=await fetch("/rest/api/3/field");o.ok&&(await o.json()).forEach(d=>{n[d.name.toLowerCase()]=d.id})}catch(o){console.warn("JiraParser: Field discovery failed, falling back to heuristics",o)}const a=await fetch(`/rest/api/3/issue/${r}`,{method:"GET",headers:{Accept:"application/json"}});if(!a.ok)throw new Error(`JiraParser: API Error ${a.status} fetching issue ${r}`);const s=(await a.json()).fields||{},u=s.summary||"",c=s.description?this.parseADF(s.description):"",g=s.status?.name||"Pending",m=s.assignee?.displayName||"Unassigned",y=s.reporter?.displayName||"Unknown",v=s.priority?.name||"Medium",L=s.issuetype?.name||"other",T=s.labels||[],$=s.created,P=s.updated,w=o=>{for(const b of o){const d=b.toLowerCase();for(const h of Object.keys(n))if(h.toLowerCase().includes(d)||d.includes(h.toLowerCase())){const q=n[h],p=s[q];if(p!=null&&p!==""){const S=typeof p=="object"?p.value||p.name||p.label||p.displayName||"":String(p).trim();if(S&&!["none","null","n/a"].includes(S.toLowerCase()))return S}}}return""};let f=w(["T-shirt Size","T-shirt sizing","Tshirt","Sizing","Size","ET - Size"]);if(!f||f==="N/A"){const o=["XS","S","M","L","XL","XXL"];for(const b of Object.keys(s)){if(!b.startsWith("customfield_"))continue;const d=s[b];if(!d)continue;const h=(typeof d=="object"?d.value||d.name||"":String(d)).trim().toUpperCase();if(o.includes(h)){f=h;break}}}const j=w(["Work Type","Issue Type Detail","Work Item Type"]),R=w(["Requesting Business Team","Business Team","Requesting Team","Team"]),N=w(["Business Objective","Objective","Goal","Business Value"]),D=w(["ET - Impact","Business Impact","Impact","Severity Impact","Level","Severity","Class"])||s.priority?.name||"",U=n.sprint,F=(s[U]||[]).map(o=>o.name),k=await this.extractComments(e,r);if(!f||f==="N/A"){const o=k.map(h=>h.body).join(" "),b=/(?:estimated|size|sizing|estimate|estimated as|estimated at)\s*(?:is|as|at|:)?\s*\b(XS|S|M|L|XL|XXL)\b/i,d=o.match(b);d&&(f=d[1].toUpperCase(),console.log(`JiraParser: Extracted T-shirt size ${f} from comments fallback.`))}let E=[];const J=s.issuelinks||[],B=s.subtasks||[],C=[...J.map(o=>(o.outwardIssue||o.inwardIssue)?.key),...B.map(o=>o.key)].filter(Boolean).slice(0,10);return C.length>0&&(console.log(`JiraParser: Fetching context for ${C.length} linked issues...`),E=await Promise.all(C.map(o=>this.fetchLinkedIssueDetails(o,n)))),{id:r,source:"jira",key:r,title:u,description:c,status:g,type:this.mapType(L),priority:v,assignee:m,reporter:y,labels:T,url:t,comments:k,sprints:F,tShirtSize:f||"N/A",workType:j,businessTeam:R,businessObjective:N,impact:D,createdDate:$,updatedDate:P,linkedIssues:E,metadata:s}}async fetchLinkedIssueDetails(e,t){try{const r=await fetch(`/rest/api/3/issue/${e}?fields=summary,comment,${t["t-shirt size"]||""}`);if(!r.ok)return{key:e,title:"Error fetching",url:`https://${location.hostname}/browse/${e}`};const a=(await r.json()).fields||{},l=t["t-shirt size"],s=l&&(a[l]?.value||a[l]?.name||a[l])||"",u=a.comment?.comments||[],c=u.length>0?this.extractRationale(u[u.length-1].body):"No technical notes recorded.";return{id:e,key:e,title:a.summary||"",tShirtSize:s,rationale:c,url:`https://${location.hostname}/browse/${e}`}}catch{return{key:e,title:"Network Error",url:`https://${location.hostname}/browse/${e}`}}}extractRationale(e){const r=this.parseADF(e).split(`
`).filter(n=>n.trim().length>0);return r.slice(0,2).join(" ")+(r.length>2?"...":"")}scrubJiraUI(e,t){if(!e)return"";const r=["Sort in ascending order","Sort in descending order","Sort A to Z","Sort Z to A","More actions for","â€¢",t,"Assign to me","Assign to","None","Add a descriptionâ€¦","Add a description"];let n=e;r.forEach(s=>{n=n.replace(new RegExp(s,"gi"),"")}),n=n.replace(/Sort A to Z.*/gi,""),n=n.replace(/More actions for.*/gi,"");const a=n.trim().split(/\s+/),l=[];for(let s=0;s<a.length;s++)(s===0||a[s].toLowerCase()!==a[s-1].toLowerCase())&&l.push(a[s]);return l.join(" ")||"Pending"}cleanDescription(e){let t=this.cleanContent(e);return/add\s+a\s+description/i.test(t)?"":t}cleanAssignee(e){if(!e||e.toLowerCase()==="unassigned")return"Unassigned ðŸ‘¤";let t=e.replace(/^Assignee/i,"").trim();return["Sort A to Z","More actions for Assignee","Sort A to ZMore actions for Assignee","â€¢"].forEach(n=>t=t.replace(n,"")),this.scrubJiraUI(t,"Assignee").trim()}findFieldByLabel(e,t){const n=Array.from(e.querySelectorAll("div, span, label, strong")).find(a=>a.textContent?.trim().toLowerCase()===t.toLowerCase());if(n){const a=n.parentElement,l=a?.parentElement;return a?.textContent?.replace(t,"").trim()||l?.textContent?.replace(t,"").trim()||""}return""}extractDescriptionHeuristic(e){const r=Array.from(e.querySelectorAll("h2, h3, strong, div")).find(n=>n.textContent?.trim()==="Description");if(r){let n=r.nextElementSibling;for(;n;){const a=n.textContent?.trim();if(a)return a;n=n.nextElementSibling}}return""}extractAssigneeHeuristic(e){const t=e.querySelectorAll('[data-testid^="issue.views.issue-base.context.people"]');for(const r of t){const n=r.textContent?.trim();if(n&&n.includes("Assignee"))return n.replace("Assignee","").trim()}return""}cleanContent(e){return!e||e==="_No description provided_"?"_No description provided_":e.replace(/<br\s*\/?>/gi,`
`).replace(/<\/p>/gi,`

`).replace(/<[^>]*>/g,"").replace(/([.:])([A-Z])/g,`$1

$2`).replace(/\n{3,}/g,`

`).trim()}async extractComments(e,t){if(!t)return[];try{console.log(`JiraParser: Fetching comments for ${t} via API...`);const r=await fetch(`/rest/api/3/issue/${t}/comment?expand=renderedBody`,{method:"GET",headers:{Accept:"application/json"}});if(!r.ok)return console.error(`JiraParser: API Error ${r.status} ${r.statusText}`),r.status===401||r.status===403?[{id:"error-auth",author:"System",body:"Error: Could not access Jira API. Please ensure you are logged in.",timestamp:new Date().toISOString()}]:[];const n=await r.json();return!n.comments||!Array.isArray(n.comments)?[]:n.comments.map((s,u)=>{let c="";if(s.body&&typeof s.body=="object")try{c=this.parseADF(s.body)}catch(y){console.error("JiraParser: ADF Parse Error",y),s.renderedBody&&(c=this.cleanCommentBody(s.renderedBody,e))}else s.renderedBody?c=this.cleanCommentBody(s.renderedBody,e):s.body&&typeof s.body=="string"?c=s.body:c="[Content Not Available]";const g=s.author?.displayName||"Unknown User";let m=new Date().toISOString();try{s.created&&(m=new Date(s.created).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{}return console.log(`JiraParser: Processing API Comment ${s.id}: Author=${g}`),{id:s.id||`comment-${u}`,author:g,body:c,timestamp:m}}).filter(s=>s!==null).reverse()}catch(r){return console.error("JiraParser: API Fetch Exception",r),[{id:"error-exception",author:"System",body:`Error: API Fetch failed. ${r}`,timestamp:new Date().toISOString()}]}}parseADF(e){if(!e)return"";let t="";switch(e.type){case"doc":case"paragraph":case"bulletList":case"orderedList":case"listItem":case"blockquote":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=this.parseADF(r)}),e.type!=="doc"&&(t+=`
`));break;case"text":t+=e.text||"";break;case"hardBreak":t+=`
`;break;case"inlineCard":case"blockCard":case"embedCard":e.attrs&&e.attrs.url?t+=` [Link: ${e.attrs.url}] `:t+=" [Linked Item] ";break;case"mention":e.attrs&&e.attrs.text?t+=` ${e.attrs.text} `:t+=" @user ";break;case"extension":case"bodiedExtension":case"inlineExtension":t+=` [Embedded Content: ${e.attrs?.extensionKey||"Extension"}] `;break;case"table":case"tableRow":case"tableHeader":case"tableCell":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=this.parseADF(r),(e.type==="tableCell"||e.type==="tableHeader")&&(t+=" | ")}),e.type==="tableRow"&&(t+=`
`));break;default:e.content&&Array.isArray(e.content)&&e.content.forEach(r=>{t+=this.parseADF(r)});break}return t}cleanCommentBody(e,t){const r=t.createElement("div");r.innerHTML=e,r.querySelectorAll('[data-node-type="inlineCard"], [data-node-type="blockCard"], .jira-issue-card, .smart-link, [data-testid*="inline-card"], [data-testid*="issue.views.issue-base.content.issue-links"]').forEach(s=>{const u=s.querySelector("a");let c="[Linked Issue]";if(u){const y=(u.getAttribute("href")||"").match(/browse\/([A-Z]+-\d+)/);y?c=` ${y[1]} `:c=` ${u.textContent?.trim()||"Linked Issue"} `}else if(s.getAttribute("data-card-data"))try{const m=JSON.parse(s.getAttribute("data-card-data")||"{}");m.url&&(c=` [${m.url}] `)}catch{}c.length>50&&(c=" [Linked Link] ");const g=t.createTextNode(c);s.parentNode?.replaceChild(g,s)}),r.querySelectorAll("style, script, svg").forEach(s=>s.remove());let l=r.innerText||r.textContent||"";return l=l.replace(/\n\s*\n\s*\n/g,`

`).replace(/[ \t]+/g," "),l.trim()}scrubCommentText(e){if(!e)return"";const t=["Add a commentâ€¦","Add a comment","Add a descriptionâ€¦","Add a description","More options","Suggest a reply"];let r=e;return t.forEach(n=>{r=r.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"gi"),"")}),r=r.replace(/pro\s*tip:\s*press\s*m\s*to\s*comment/gi,""),r=r.replace(/\s{2,}/g," "),r=r.replace(/\d+\s*(hours?|minutes?|days?|weeks?)\s*ago(\(edited\))?/gi,""),r=r.replace(/(\b\w+\b)\s+\1\s+/gi,"$1 "),r.trim()}extractKeyFromUrl(e){const t=e.match(/browse\/([A-Z]+-\d+)/);return t?t[1]:""}mapType(e){const t=e.toLowerCase();return t.includes("bug")?"bug":t.includes("story")?"story":t.includes("epic")?"epic":t.includes("task")?"task":"other"}}console.log("Jira to NotebookLM: Content script loaded");const A=new z;chrome.runtime.onMessage.addListener((i,e,t)=>{if(i.type==="EXTRACT_ISSUE")return X().then(t),!0;if(i.type==="GET_ISSUE_KEY")return M().then(t),!0});async function M(){try{const i=window.location.href;if(!A.canParse(i))return{error:"Not a supported Jira Issue URL"};const t=document.querySelector('[data-testid="issue.views.issue-base.foundation.breadcrumbs.breadcrumb-current-issue-container"] a')?.textContent?.trim()||A.extractKeyFromUrl(i),n=(document.querySelector('[data-testid="issue.views.issue-base.foundation.summary.heading"]')||document.querySelector("h1"))?.textContent?.trim()||t;return{key:t,title:n}}catch(i){return{error:i.message}}}async function X(){try{const i=window.location.href;return A.canParse(i)?(await x(),await I(300),{type:"EXTRACT_SUCCESS",payload:await A.parse(document,i)}):{type:"EXTRACT_ERROR",error:"Not a supported Jira Issue URL"}}catch(i){return console.error("Extraction Error:",i),{type:"EXTRACT_ERROR",error:i.message||"Unknown parsing error"}}}async function x(){const i=['[data-testid="issue.activity.common.show-older-button"]','[data-testid="issue-activity-feed.ui.buttons.show-more-button"]','button[aria-label*="Show"]','button[aria-label*="more"]','button[aria-label*="older"]',".show-more-comments",'[data-testid*="show-more"]','[data-testid*="expand"]'];let e=!1;for(const t of i){const r=document.querySelectorAll(t);for(const n of r)n instanceof HTMLElement&&(console.log("Clicking expand button:",t),n.click(),e=!0)}e&&(await I(2e3),await x())}function I(i){return new Promise(e=>setTimeout(e,i))}
})()