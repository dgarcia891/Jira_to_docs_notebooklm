(function(){function b(e){if(!e)return"";let t="";switch(e.type){case"doc":case"paragraph":case"bulletList":case"orderedList":case"listItem":case"blockquote":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=b(r)}),e.type!=="doc"&&(t+=`
`));break;case"text":t+=e.text||"";break;case"hardBreak":t+=`
`;break;case"inlineCard":case"blockCard":case"embedCard":e.attrs&&e.attrs.url?t+=` [Link: ${e.attrs.url}] `:t+=" [Linked Item] ";break;case"mention":e.attrs&&e.attrs.text?t+=` ${e.attrs.text} `:t+=" @user ";break;case"extension":case"bodiedExtension":case"inlineExtension":t+=` [Embedded Content: ${e.attrs?.extensionKey||"Extension"}] `;break;case"table":case"tableRow":case"tableHeader":case"tableCell":e.content&&Array.isArray(e.content)&&(e.content.forEach(r=>{t+=b(r),(e.type==="tableCell"||e.type==="tableHeader")&&(t+=" | ")}),e.type==="tableRow"&&(t+=`
`));break;default:e.content&&Array.isArray(e.content)&&e.content.forEach(r=>{t+=b(r)});break}return t}function $(e,t){if(!e)return"";const r=["Sort in ascending order","Sort in descending order","Sort A to Z","Sort Z to A","More actions for","â€¢",t,"Assign to me","Assign to","None","Add a descriptionâ€¦","Add a description"];let a=e;r.forEach(n=>{a=a.replace(new RegExp(n,"gi"),"")}),a=a.replace(/Sort A to Z.*/gi,""),a=a.replace(/More actions for.*/gi,"");const i=a.trim().split(/\s+/),o=[];for(let n=0;n<i.length;n++)(n===0||i[n].toLowerCase()!==i[n-1].toLowerCase())&&o.push(i[n]);return o.join(" ")||"Pending"}function v(e){let t=x(e);return/add\s+a\s+description/i.test(t)?"":t}function U(e){if(e.toLowerCase()==="unassigned")return"Unassigned ðŸ‘¤";let t=e.replace(/^Assignee/i,"").trim();return["Sort A to Z","More actions for Assignee","Sort A to ZMore actions for Assignee","â€¢"].forEach(a=>t=t.replace(a,"")),$(t,"Assignee").trim()}function x(e){return!e||e==="_No description provided_"?"_No description provided_":e.replace(/<br\s*\/?>/gi,`
`).replace(/<\/p>/gi,`

`).replace(/<[^>]*>/g,"").replace(/([.:])([A-Z])/g,`$1

$2`).replace(/\n{3,}/g,`

`).trim()}function j(e){const t=e.match(/browse\/([A-Z]+-\d+)/);return t?t[1]:""}function I(e){const t=e.toLowerCase();return t.includes("bug")?"bug":t.includes("story")?"story":t.includes("epic")?"epic":t.includes("task")?"task":"other"}function S(e,t){const r=t.createElement("div");r.innerHTML=e,r.querySelectorAll('[data-node-type="inlineCard"], [data-node-type="blockCard"], .jira-issue-card, .smart-link, [data-testid*="inline-card"], [data-testid*="issue.views.issue-base.content.issue-links"]').forEach(n=>{const s=n.querySelector("a");let l="[Linked Issue]";if(s){const p=(s.getAttribute("href")||"").match(/browse\/([A-Z]+-\d+)/);p?l=` ${p[1]} `:l=` ${s.textContent?.trim()||"Linked Issue"} `}else if(n.getAttribute("data-card-data"))try{const m=JSON.parse(n.getAttribute("data-card-data")||"{}");m.url&&(l=` [${m.url}] `)}catch{}l.length>50&&(l=" [Linked Link] ");const d=t.createTextNode(l);n.parentNode?.replaceChild(d,n)}),r.querySelectorAll("style, script, svg").forEach(n=>n.remove());let o=r.innerText||r.textContent||"";return o=o.replace(/\n\s*\n\s*\n/g,`

`).replace(/[ \t]+/g," "),o.trim()}async function L(e,t,r){console.log(`JiraParser: Discovering children for Epic ${e}...`);const a=await fetch(`${t}/rest/api/3/search/jql`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-Atlassian-Token":"no-check","X-Requested-With":"XMLHttpRequest",...r},body:JSON.stringify({jql:`"parent" = ${e} OR "Epic Link" = ${e} order by created ASC`,fields:["key"],maxResults:100})});if(!a.ok){const o=await a.text().catch(()=>"Unknown error");throw new Error(`Failed to fetch epic children for ${e} (${a.status}): ${o}`)}return(await a.json()).issues.map(o=>o.key)}async function P(e,t,r,a){try{const i=["summary","description","status","priority","comment",t["t-shirt size"]].filter(Boolean).join(","),o=await fetch(`${r}/rest/api/3/issue/${e}?fields=${i}`,{headers:{Accept:"application/json",...a}});if(!o.ok)return{key:e,title:"Error fetching",url:`${r}/browse/${e}`};const s=(await o.json()).fields||{},l=t["t-shirt size"],d=l&&(s[l]?.value||s[l]?.name||s[l])||"",m=s.description?b(s.description):"No description provided.",p=s.status?.name||"Unknown",h=s.priority?.name||"Medium",E=s.comment?.comments||[],C=E.map(y=>{let c="";try{c=b(y.body)}catch{c=String(y.body)}return{id:y.id,author:y.author?.displayName||"Unknown User",body:c.trim(),timestamp:y.created?new Date(y.created).toLocaleString():""}}).reverse(),k=C.length>0?T(E[E.length-1].body):"No technical notes recorded.";return{id:e,key:e,title:s.summary||"",description:m,status:p,priority:h,comments:C,tShirtSize:d,rationale:k,url:`${r}/browse/${e}`}}catch{return{key:e,title:"Network Error",url:`${r}/browse/${e}`}}}function T(e){const r=b(e).split(`
`).filter(a=>a.trim().length>0);return r.slice(0,2).join(" ")+(r.length>2?"...":"")}async function B(e,t,r,a){if(!a)return[];try{console.log(`JiraParser: Fetching comments for ${a} via API...`);const i=await fetch(`${e}/rest/api/3/issue/${a}/comment?expand=renderedBody`,{method:"GET",headers:{Accept:"application/json",...t}});if(!i.ok)return console.error(`JiraParser: API Error ${i.status} ${i.statusText}`),i.status===401||i.status===403?[{id:"error-auth",author:"System",body:"Error: Could not access Jira API. Please ensure you are logged in.",timestamp:new Date().toISOString()}]:[];const o=await i.json();return!o.comments||!Array.isArray(o.comments)?[]:o.comments.map((s,l)=>{let d="";if(s.body&&typeof s.body=="object")try{d=b(s.body)}catch{s.renderedBody&&(d=S(s.renderedBody,r))}else s.renderedBody?d=S(s.renderedBody,r):s.body&&typeof s.body=="string"?d=s.body:d="[Content Not Available]";const m=s.author?.displayName||"Unknown User";let p=new Date().toISOString();try{s.created&&(p=new Date(s.created).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{}return{id:s.id||`comment-${l}`,author:m,body:d.trim(),timestamp:p}}).filter(s=>s!==null).reverse()}catch(i){return console.error("JiraParser: API Fetch Exception",i),[{id:"error-exception",author:"System",body:`Error: API Fetch failed. ${i}`,timestamp:new Date().toISOString()}]}}class R{canParse(t){return/atlassian\.net\/(browse\/|jira\/software\/.*(selectedIssue=|issues\/))/.test(t)}baseUrlOverride=null;jiraEmail=null;jiraApiToken=null;setCredentials(t,r){this.jiraEmail=t,this.jiraApiToken=r}setBaseUrl(t){try{const r=new URL(t);this.baseUrlOverride=`${r.protocol}//${r.host}`}catch{this.baseUrlOverride=null}}getApiUrl(t){return this.baseUrlOverride?`${this.baseUrlOverride}${t}`:t}getBaseUrl(){return this.baseUrlOverride||""}getAuthHeaders(){return this.jiraEmail&&this.jiraApiToken?{Authorization:`Basic ${btoa(`${this.jiraEmail}:${this.jiraApiToken}`)}`}:{}}async parse(t,r){this.setBaseUrl(r);let a=j(r);if(a||(a=t.querySelector('[data-testid="issue.views.issue-base.foundation.breadcrumbs.breadcrumb-current-issue-container"] a')?.textContent?.trim()||""),!a)throw new Error("Could not extract Issue Key");return this.parseByKey(a,t)}async parseByKey(t,r){console.log(`JiraParser: Fetching issue ${t} data via API...`);let a={};try{const c=await fetch(this.getApiUrl("/rest/api/3/field"),{headers:{Accept:"application/json",...this.getAuthHeaders()}});c.ok&&(await c.json()).forEach(u=>{a[u.name.toLowerCase()]=u.id})}catch(c){console.warn("JiraParser: Field discovery failed",c)}const i=await fetch(this.getApiUrl(`/rest/api/3/issue/${t}`),{method:"GET",headers:{Accept:"application/json",...this.getAuthHeaders()}});if(!i.ok)throw new Error(`JiraParser: API Error ${i.status} fetching issue ${t}`);const n=(await i.json()).fields||{},s=c=>{const u=c.map(w=>w.toLowerCase()).map(w=>a[w]).filter(w=>w!==void 0);for(const w of u){const f=n[w];if(f!=null){if(typeof f=="object")return f.value?f.value:f.name?f.name:JSON.stringify(f);if(String(f).trim()!=="")return String(f)}}return"N/A"},l=n.issuetype?.name||"other",d=I(l),m=`${this.getBaseUrl()||window.location.origin}/browse/${t}`,p=await B(this.getBaseUrl(),this.getAuthHeaders(),r||null,t);let h=s(["t-shirt size","tshirt","sizing","size","et - size"]);if(h==="N/A"){const c=Object.keys(n).filter(g=>g.startsWith("customfield_"));for(const g of c){const u=n[g];if(u&&typeof u=="object"&&u.value&&/^(XS|S|M|L|XL|XXL)$/i.test(u.value)){h=u.value;break}}}if(h==="N/A"&&p.length>0){const c=/estimated as (XS|S|M|L|XL|XXL)/i;for(const g of p){const u=g.body.match(c);if(u){h=u[1].toUpperCase();break}}}let E=[];const C=n.issuelinks||[],k=n.subtasks||[],y=[...C.filter(c=>c.type?.name!=="Cloners").map(c=>(c.outwardIssue||c.inwardIssue)?.key),...k.map(c=>c.key)].filter(Boolean).slice(0,10);return y.length>0&&(E=await Promise.all(y.map(c=>P(c,a,this.getBaseUrl(),this.getAuthHeaders())))),{id:t,source:"jira",key:t,title:n.summary||"",description:v(n.description?b(n.description):""),status:n.status?.name||"Pending",type:d,priority:n.priority?.name||"Medium",assignee:U(n.assignee?.displayName||"Unassigned"),reporter:n.reporter?.displayName||"Unknown",labels:n.labels||[],url:m,comments:p,createdDate:n.created,updatedDate:n.updated,sprints:n[a.sprint]?.map(c=>c.name)||[],tShirtSize:h,workType:s(["work type","work item type"]),businessTeam:s(["requesting business team","team"]),businessObjective:s(["business objective","goal","business value"]),impact:s(["et - impact","impact","level","severity","class"]),linkedIssues:E.filter(Boolean),metadata:n}}async fetchEpicChildren(t){return L(t,this.getBaseUrl(),this.getAuthHeaders())}}console.log("Jira to NotebookLM: Content script loaded");const A=new R;chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="EXTRACT_ISSUE")return O().then(r),!0;if(e.type==="GET_ISSUE_KEY")return N().then(r),!0;if(e.type==="FETCH_EPIC_BULK")return q(e.payload.epicKey).then(r),!0});async function N(){try{const e=window.location.href;if(!A.canParse(e))return{error:"Not a supported Jira Issue URL"};const t=e.match(/browse\/([A-Z]+-\d+)/),r=t?t[1]:void 0,a=document.querySelector("h1")?.innerText||document.title;let i="";const o=document.querySelector('[data-testid="issue.views.field.issue-type.common.ui.issue-type-field-view"] [data-testid*="issue-type-icon"]');if(o&&(i=o.textContent?.trim()||""),i||document.querySelector('img[alt*="Epic"]')&&(i="Epic"),i||document.querySelector('[aria-label*="Epic"]')&&(i="Epic"),!i){const s=document.querySelectorAll('[data-testid*="issue-type"]');for(const l of s)if((l.textContent?.trim()||"").toLowerCase().includes("epic")){i="Epic";break}}if(!i){const s=document.querySelector('[data-testid="issue-field-summary.ui.issue-field-summary-inline-edit--trigger"]');if(s){const l=s.querySelector('span[data-testid*="issue-type-icon"]');l?i=l.textContent?.trim()||"":i=s.textContent?.trim()||""}}let n=[];if(i.toLowerCase().includes("epic")&&r)try{console.log(`Content: Epic detected (${r}), fetching child keys for dynamic naming...`),n=await A.fetchEpicChildren(r)}catch(s){console.warn("Content: Failed to fetch child keys for naming fallback",s)}return{key:r,title:a,type:i,childKeys:n}}catch(e){return{error:e.message}}}async function O(){try{const e=window.location.href;return A.canParse(e)?{type:"EXTRACT_SUCCESS",payload:await A.parse(document,e)}:{type:"EXTRACT_ERROR",error:"Not a supported Jira Issue URL"}}catch(e){return console.error("Extraction Error:",e),{type:"EXTRACT_ERROR",error:e.message||"Unknown parsing error"}}}function _(e){return new Promise(t=>setTimeout(t,e))}async function q(e){try{console.log(`Content: Starting Epic bulk fetch for ${e}`);const t=await A.fetchEpicChildren(e),r=[e,...t];console.log(`Content: Found ${t.length} children for Epic ${e}`);const a=[];for(let i=0;i<r.length;i++){const o=r[i];chrome.runtime.sendMessage({type:"EPIC_BULK_PROGRESS",payload:{current:i+1,total:r.length*2,key:o}}).catch(()=>{}),console.log(`Content: Fetching ${o} (${i+1}/${r.length})`);const n=await A.parseByKey(o);a.push(n),await _(100)}return console.log(`Content: Successfully fetched ${a.length} items`),{type:"EPIC_BULK_SUCCESS",success:!0,payload:{epicKey:e,items:a}}}catch(t){return console.error("Content: Epic bulk fetch failed",t),{type:"EPIC_BULK_ERROR",success:!1,error:t.message||"Failed to fetch Epic data"}}}
})()